<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat com LLM</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.global.min.js"></script>
    <style>
      .chat-container {
        height: calc(100vh - 200px);
        overflow-y: auto;
        padding: 1rem;
        background-color: #f5f5f5;
        border-radius: 6px;
      }
      .message-container {
        margin-bottom: 1rem;
      }
      .message {
        max-width: 80%;
        margin-bottom: 0.5rem;
      }
      .user-message {
        margin-left: auto;
      }
      .bot-message {
        margin-right: auto;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <section class="section">
        <div class="container">
          <h1 class="title has-text-centered">
            <span class="icon">
              <i class="fas fa-robot"></i>
            </span>
            Rag Test
          </h1>
          <div class="box chat-container">
            <div
              v-for="(message, index) in messages"
              :key="index"
              class="message-container"
            >
              <article
                class="message is-primary user-message"
                v-if="message.type === 'user'"
              >
                <div class="message-body">{{ message.content }}</div>
              </article>
              <article class="message is-info bot-message" v-else>
                <div class="message-body">{{ message.content }}</div>
              </article>
            </div>
          </div>

          <div class="field has-addons mt-4">
            <div class="control is-expanded">
              <input
                class="input"
                type="text"
                v-model="prompt"
                placeholder="Digite sua mensagem..."
                @keyup.enter="callModel"
              />
            </div>
            <div class="control">
              <button
                class="button is-primary"
                @click="callModel"
                :class="{'is-loading': isLoading}"
              >
                <span class="icon">
                  <i class="fas fa-paper-plane"></i>
                </span>
                <span>Enviar</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
    <script>
      const app = Vue.createApp({
        data() {
          return {
            prompt: "",
            messages: [],
            isLoading: false,
            currentResponse: "",
          };
        },
        methods: {
          async callModel() {
            if (!this.prompt.trim()) return;

            this.isLoading = true;
            // Adiciona a mensagem do usuário
            this.messages.push({
              type: "user",
              content: this.prompt
            });

            const evtSource = new EventSource(
              "http://localhost:8081/ai/ask/stream?prompt=" +
                encodeURIComponent(this.prompt)
            );

            // Limpa o prompt após enviar
            this.prompt = "";
            let botMessage = "";

            evtSource.onmessage = (event) => {
              if (event.data === "[DONE]") {
                evtSource.close();
                this.isLoading = false;
                return;
              }

              // Concatena o texto recebido
              botMessage += event.data;

              // Atualiza ou adiciona a mensagem do bot
              const lastMessage = this.messages[this.messages.length - 1];
              if (lastMessage && lastMessage.type === "bot") {
                lastMessage.content = botMessage;
              } else {
                this.messages.push({
                  type: "bot",
                  content: botMessage
                });
              }
            };

            evtSource.onerror = (error) => {
              console.error("Erro na conexão SSE:", error);
              evtSource.close();
              this.isLoading = false;
            };
          },
        },
        mounted() {
          this.messages.push({
            type: "bot",
            content: "Olá! Como posso ajudar você hoje?",
          });
        },
      });
      app.mount("#app");
    </script>
  </body>
</html>
